var Fingerboard=window.Fingerboard=function(a,b){var c=function(){var a={noteclick:[],notehover:[],modelchange:[]},b={broadcast:function(b,c){a[b]&&a[b].forEach(function(a){a(c())})},on:function(b,c){a[b]||(a[b]=[]),a[b].push(c)}};for(var c in a)b[c]=function(b){return function(c){a[b].push(c)}}(c);return b}();for(var d in c)this[d]=c[d];{var e=new Fingerboard.Model(b,c);new Fingerboard.View(b,a,e,c)}this.set=e.set,this.getNoteFor=function(a,b){return getNoteFor(a,b).clone()},this.setNoteFor=function(a,b,d){var e=getNoteFor(a,b);for(var f in d)e[f]=d[f];c.broadcast("modelchange",function(){return d})},this.frets=function(){return e.frets},this.strings=function(){return e.strings},this.tuning=function(){var a=e.settings.tuning.slice();return a.reverse(),a},this.select=function(a){e.select(a),c.broadcast("modelchange",function(){return a})},this.notationFromFreqId=e.notationFromFreqId};!function(a){a.ContextWrapper=function(a){var b=this;for(var c in a)b[c]="function"==typeof a[c]?function(a,c){return function(){return c[a].apply(c,arguments),b}}(c,a):function(a,c){return function(d){return c[a]=d,b}}(c,a);b.context=a,b.begin=function(){return a.beginPath(),b},b.beginAt=function(c,d){return a.beginPath(),a.moveTo(c,d),b},b.color=function(c){return a.fillStyle=c,b},b.get=function(b){return a[b]}}}(Fingerboard),function(a){a.Clonify=Clonify=function(a){switch(typeof a){case"undefined":return;case"number":return Number(a);case"object":if(Array.isArray(a))return a.map(function(a){return Clonify(a)});var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=Clonify(a[c]));return b;case"string":return String(a);case"function":var d=function(){return a.apply(this,arguments)};for(var c in a)a.hasOwnProperty(c)&&(d[c]=Clonify(a[c]));return d;case"date":return new Date(a.valueOf());case"boolean":return Boolean(a)}throw"Type "+typeof a+" not clonable"},a.Polymorphy=function(){},a.Polymorphy.extends=function(a){var b,c=function(a){for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])a[c]=Clonify(arguments[b][c]);return a},d=this;b=a&&"constructor"in a?a.constructor:function(){return d.apply(this,arguments)};var e=function(){this.constructor=b};return e.prototype=d.prototype,b.prototype=new e,a&&c(b.prototype,a),b.__super__=d.prototype,b},a.Polymorphy.prototype.clone=function(){return Clonify(this)}}(Fingerboard),function(a,b,c){function d(a,b,c,d){this.x1=a?a:-1,this.y1=b?b:-1,this.x2=c?c:-1,this.y2=d?d:-1}function e(){this.freqId=-1,this.index=-1,this.value=-1,this.notation="",this.shift=-1,this.degree=""}d.prototype.isPointWithinBounds=function(a,b){return a>this.x1&&a<this.x2&&b>this.y1&&b<this.y2},d.prototype.public=function(a){function b(b){return{enumerable:!0,get:function(){return e[b]},set:function(c){e[b]=c,a.broadcast("modelchange",function(){return{name:"Square:"+b,value:c}})}}}if(!this.__public__){var c={},e=this;Object.defineProperties(c,{x1:b("x1"),y1:b("y1"),x2:b("x2"),y2:b("y2")}),c.isPointWithinBounds=d.prototype.isPointWithinBounds,this.__public__=c}return this.__public__},e.prototype.public=function(a){function b(b){return{enumerable:!0,get:function(){return d[b]},set:function(c){d[b]=c,a.broadcast("modelchange",function(){return{name:"Square:"+b,value:c}})}}}if(!this.__public__){var c={},d=this;Object.defineProperties(c,{freqId:b("freqId"),index:b("index"),notation:b("notation"),value:b("value"),shift:b("shift"),degree:b("degree")}),this.__public__=c}return this.__public__};var f=c.extends({constructor:function(a,b){this.fret=a,this.string=b,this.selector="",this.dimension=new d,this.interval=new e}});f.prototype.public=function(a){function b(b){return{enumerable:!0,get:function(){return d[b]},set:function(c){S[b]=c,a.broadcast("modelchange",function(){return{name:"Square:"+b,value:c}})}}}if(!this.__public__){var c={},d=this;Object.defineProperties(c,{frets:b("frets"),string:b("string"),dimension:{enumerable:!0,writable:!1,value:d.dimension.public(a)},selector:b("selector"),interval:{enumerable:!0,writable:!1,value:d.interval.public(a)}}),console.log("public interface:",c),this.__public__=c}return this.__public__},a.Model=function(a,c){var d,e=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];this.settings=settings={notation:e,selectors:{}};var g=function(a){if("string"==typeof a){if("["===a[0])return JSON.parse(a);if(-1!==a.indexOf(","))return a.split(",").map(function(a){if(isNaN(a))throw"Invalid array input.";return Number(a)});throw"Cannot process array argument "+a}return a};this.getNoteFor=getNoteFor=function(a,b){return d[a][b-1]},this.frets=function(){return d.length},this.strings=strings=function(){return d[0].length},this.find=find=function(a){var b=void 0;return this.forEach(function(c,d,e){return a(c,d,e)===!0?(b=e,!1):void 0}),b},this.forEach=forEach=function(a){for(var b=0;b<d.length;b++)for(var c=1;c<=d[0].length;c++)if(a(b,c,getNoteFor(b,c))===!1)return},this.select=select=function(a){"scale"===a&&forEach(function(a,b,c){c.selector=1===c.interval.shift?"tonic":c.interval.degree?"selected":""})};var h=function(a,b){if(void 0===a&&(a=d.length-1||15),void 0===b&&(b=d[0].length||6),"number"!=typeof a){if(isNaN(a))throw"Frets property is not a number.";a=Number(a)}if("number"!=typeof b){if(isNaN(b))throw"Strings property is not a number.";b=Number(b)}if(1>a)throw"Not enough frets.";if(1>b)throw"Not enough strings.";d=[];for(var c=0;a>=c;c++){d[c]=[];for(var e=1;b>=e;e++)d[c][e-1]=new f(c,e,this)}},i=function(a){var b=a.notation||settings.notation,c=a.maxIndex||8,d=g(a.tuning)||settings.tuning,f=1,h=0,i=[],j=b.length||a.scaleLength;if(!d){if(!b.every(function(a,b){return e[b]===a})||6!==strings())throw"Interval needs more arguments.";var k=function(a,b){return 12*b+e.indexOf(a)};d=[k("E",2),k("A",2),k("D",3),k("G",3),k("B",3),k("E",4)]}for(var l=0;j*(c+1)>l;l++)i.push({value:f,index:h,freqId:l+1,notation:b[f-1]||void 0}),f>=j?(f=1,h++):f++;d=d.reverse(),forEach(function(a,b,c){c.interval=i[d[b-1]+a]}),settings.tuning=d,settings.notation=b,settings.scaleLength=j},j=function(a){var b=settings.scaleLength;forEach(function(c,d,e){e.interval.shift=e.interval.value-a+1,e.interval.shift<1&&(e.interval.shift+=b)}),settings.root=a};this.buildScale=buildScale=function(a){var b,c=a&&g(a.values)||settings.scale,d=(settings.scaleLength,[]);(a&&a.root||!settings.root)&&j(a&&a.root||settings.root||1),c.forEach(function(a,b){d[a]=b+1}),forEach(function(a,c,e){e.interval.degree=(b=d[e.interval.shift])?b:void 0}),settings.scale=c,a&&a.select&&select("scale")},this.set=set=function(a){if(a.selectors)for(var d in a.selectors)settings.selectors[d]=a.selectors[d];(a.strings||a.frets)&&h(a.frets,a.strings),a.interval&&i(a.interval),a.scale&&buildScale(a.scale),a.interval&&!a.scale&&(j(settings.root),buildScale(),select("scale")),c.broadcast("modelchange",function(){return b(a)})},this.notationFromFreqId=function(a){var b=settings.notation.length;return settings.notation[a%b]+""+Math.floor(a/b)},this.get=get=function(){if(1===arguments.length)return b(settings[arguments[0]]);for(var a={},c=0;c<arguments.length;c++)a[arguments[c]]=b(settings[arguments[c]]);return a},a?set(a):h()}}(Fingerboard,Fingerboard.Clonify,Fingerboard.Polymorphy),function(a){a.Selectors={},a.Selectors.notation=function(a,b,c){var a={selected:a&&a.selected||"gray",tonic:a&&a.tonic||"firebrick"},d=2*Math.PI,e=b||"700 11px tahoma",f=c||12;return function(b,c,g,h){b.begin().color(a[c.selector]).arc(g,h,f,0,d).fill(),b.begin().color("white").textAlign("center").textBaseline("middle").font(e).fillText(c.interval.notation+c.interval.index,g,h)}}}(Fingerboard),function(a,b){a.View=function(a,c,d,e){function f(){var b,c,e,f,g,h=i/(2*d.frets()),k=i-h,o=k/(d.frets()-2),p=j/d.strings(),q=d.settings.selectors,r=2*Math.PI,s=p>h?h/4:p/4,t=a.display&&a.display.selector||function(a,b,c,d){(g=q[b.selector])&&a.beginPath().color(g).arc(c,d,s,0,r).fill()};l.lineWidth=1,d.forEach(function(a,d,g){if(c=a?(a-1)*o+h:1,e=c+o-1,b=(d-1)*p+p/2,f=c+(a?o:h)/2,g.dimension.x1=c,g.dimension.y1=b-p/2,g.dimension.x2=e,g.dimension.y2=b+p/2,0===a&&l.beginPath().fillStyle(n.strings).moveTo(h,b).lineTo(i,b).stroke(),1===d)switch(1===a?(l.context.lineWidth=5,l.beginPath().fillStyle(n.frets).moveTo(c,0).lineTo(c,j).stroke(),l.context.lineWidth=1):0!==a&&l.beginPath().fillStyle(n.frets).moveTo(c,0).lineTo(c,j).stroke(),a){case 3:case 5:case 7:case 9:m(l,f,j/2,3*s,6*s);break;case 12:m(l,f,j/3,3*s,6*s),m(l,f,2*(j/3),3*s,6*s)}""!==g.selector&&t(l,g,f,b)})}function g(){i=c.width(),j=c.height(),l.get("canvas").height=j,l.get("canvas").width=i}function h(){g(),l.begin().clearRect(0,0,i,j).fill(),f()}var i,j,k=c[0],l=new b(k.getContext("2d")),m=a.display&&a.display.inlay||function(a,b,c,d,e){a.beginAt(b-d/2,c).lineTo(b,c-e/2).lineTo(b+d/2,c).lineTo(b,c+e/2).fillStyle(n.inlays).fill()};d.settings.selectors.selected="gray",d.settings.selectors.tonic="firebrick";var n={strings:"gray",inlays:"#D1A319",frets:"gray"};k.style["user-select"]="none",k.style["-webkit-user-select"]="none",k.style["-moz-user-select"]="none",g(),f(),c.click(function(){e.broadcast("noteclick",function(){return d.mouseHoveredNote.clone()})});var o,p,q=!1;c.mousemove(function(a){if(o=a.pageX-$(this).offset().left,p=a.pageY-$(this).offset().top,q=d.mouseHoveredNote?!d.mouseHoveredNote.dimension.isPointWithinBounds(o,p):!0){var b=d.find(function(a,b,c){return c.dimension.isPointWithinBounds(o,p)});b&&(d.mouseHoveredNote=b,e.broadcast("notehover",function(){return d.mouseHoveredNote.clone()}))}}),$(window).resize(h),c.on("resize",h),e.modelchange(h)}}(Fingerboard,Fingerboard.ContextWrapper);